<!doctype html>
<html>
<head>
  <title>SI 649 - Assignment 3 - What's in Season?</title>
  <!-- Scripts -->
  <script type="text/javascript" src="js/lib/jquery.min.js"></script>
  <script type="text/javascript" src="js/lib/jsOAuth-1.3.1-fsmod.js"></script>
  <script type="text/javascript" src="js/lib/protovis.min.js"></script>
  <script type="text/javascript" src="data/inseason.js"></script>
  <script type="text/javascript" src="js/data.utils.js"></script>
  <script type="text/javascript" src="js/fatsecret.js"></script>
  <script type="text/javascript" src="js/ui.js"></script>
  <!-- Styles -->
  <link rel="stylesheet" type="text/css" href="css/lib/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="css/page.css" />
  <link rel="stylesheet" type="text/css" href="css/viz.css" />
</head>
<body>
  <div class="container">
    <div class="row" id="headline">
      <h1>InSeason</h1>
    </div>
    <div class="row" id="vizview">
      <div class="span-one-third" id="filters">
        <div class="row" id="location">
          <form>
            <fieldset>
              <legend>Location</legend>
              <div class="clearfix">
                <label for="stateSelect">State</label>
                <div class="input">
                  <select name="stateSelect" id="stateSelect">
                    <option value="0">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="DC">District of Columbia</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                  </select>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="row" id="nutrition">
          <form>
            <fieldset>
              <legend>Nutritional Filters</legend>
              <div class="clearfix">
                <div class="input">
                  <ul class="inputs-list">
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="protein">
                        <span>Protein</span>
                      </label>
                    </li>
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="calcium">
                        <span>Calcium</span>
                      </label>
                    </li>
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="sodium">
                        <span>Sodium</span>
                      </label>
                    </li>
                    <li> 
                      <label>
                        <input type="checkbox" name="nutritionBox" value="fiber">
                        <span>Fiber</span>
                      </label>
                    </li>
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="vitaminc">
                        <span>Vitamin C</span>
                      </label>
                    </li>
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="potassium">
                        <span>Potassium</span>
                      </label>
                    </li>
                    <li>
                      <label>
                        <input type="checkbox" name="nutritionBox" value="fat">
                        <span>Fat</span>
                      </label>
                    </li>
                  </ul>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
      </div>
      <div class="span-two-thirds" id="viz">
      <script type="text/javascript+protovis">

// This maps each month segment to a set of angles
var monthAngles = [
    {
        month: 0,
        startAngle: -(Math.PI / 2),
        endAngle: -(Math.PI / 3)
    },
    {
        month: 1,
        startAngle: -(Math.PI / 3),
        endAngle: -(Math.PI / 6)
    },
    {
        month: 2,
        startAngle: -(Math.PI / 6),
        endAngle: 0
    },
    {
        month: 3,
        startAngle: 0,
        endAngle: (Math.PI / 6)
    },
    {
        month: 4,
        startAngle: (Math.PI / 6),
        endAngle: (Math.PI / 3)
    },
    {
        month: 5,
        startAngle: (Math.PI / 3),
        endAngle: (Math.PI / 2)
    },
    {
        month: 6,
        startAngle: (Math.PI / 2),
        endAngle: (2 * Math.PI / 3)
    },
    {
        month: 7,
        startAngle: (2 * Math.PI / 3),
        endAngle: (5 * Math.PI / 6)
    },
    {
        month: 8,
        startAngle: (5 * Math.PI / 6),
        endAngle: Math.PI
    },
    {
        month: 9,
        startAngle: -Math.PI,
        endAngle: -(5 * Math.PI / 6)
    },
    {
        month: 10,
        startAngle: -(5 * Math.PI / 6),
        endAngle: -(2 * Math.PI / 3)
    },
    {
        month: 11,
        startAngle: -(2 * Math.PI / 3),
        endAngle: -(Math.PI / 2)
    }
];

var currentMonth = (new Date()).getMonth();

var w = 500,
    h = 500,
    radius = w / 2,
    xCenter = w / 2,
    yCenter = w / 2,
    initAngle = monthAngles[currentMonth].startAngle + (Math.PI / 12),
    section = (2*Math.PI) / 12;

var vis = new pv.Panel()
    .width(radius * 2)
    .height(radius * 2);

// Arcs representing food colors
var arcs = vis.add(pv.Wedge)
    .data(STATE_DATA)
    .left(radius)
    .bottom(radius)
    .innerRadius(function(d) radius * ((COLORS[d.color].ind + 1) / 10))
    .outerRadius(function(d) radius * (((COLORS[d.color].ind + 1) / 10) + .1))
    .startAngle(function(d) d.start * section - (Math.PI/2))
    .angle(function(d) 2 * Math.PI / 12)
    .fillStyle(function(d) COLORS[d.color].hex)
    .lineWidth(1)
    .strokeStyle("#444")
    .text("blahhhh")
    .event('mouseover', function(d) linkedBrush(d))
    .event('mouseout', function(d) clearLinkedBrush(d));

// Radial gridlines
var months = vis.add(pv.Wedge)
    .data(MONTHS)
    .innerRadius(function(d) 10)
    .outerRadius(function(d) radius - 30)
    .fillStyle(null)
    .strokeStyle("black")
    .startAngle(function(d) this.index * section)
    .angle(function() Math.PI/6);

months.anchor('outer').add(pv.Label)
    .text(function(d) d)
    .textStyle('white')
    .textAlign('center')
    .textBaseline('bottom')
    .textAngle(function() this.anchorTarget().midAngle() + Math.PI / 2);

// New PV behavior that will translate mouse position onto a circle
pv.Behavior.dragCircle = function() {
    var scene, // scene context
        index, // scene context
        p, // particle being dragged
        v1, // initial mouse-particle offset
        max;

    /** @private */
    function mousedown(d) {
        index = this.index;
        scene = this.scene;
        var m = this.mouse();
        v1 = ((p = d).fix = pv.vector(d.x, d.y)).minus(m);
        max = {
            x: this.parent.width() - (d.dx || 0),
            y: this.parent.height() - (d.dy || 0)
        };
        scene.mark.context(scene, index, function() { this.render(); });
        pv.Mark.dispatch("dragstart", scene, index);
    }

    /** @private */
    function mousemove() {
        if (!scene) return;
        scene.mark.context(scene, index, function() {
            var m = this.mouse();
            // [LNF] p0 is the origin of the viz
            var p0 = {
                x: xCenter,
                y: yCenter 
            };
            // [LNF] Calc the angle between the mouse and the origin
            p.theta = Math.atan2(m.y - p0.y, m.x - p0.x);
            // [LNF] Translate the angle into cartesian coordinates, scaled to the center
            p.x = p.fix.x = (Math.cos(p.theta) * (radius * 0.965)) + xCenter;
            p.y = p.fix.y = (Math.sin(p.theta) * (radius * 0.965)) + yCenter;
            this.render();
        });
        pv.Mark.dispatch("drag", scene, index);
    }

    /** @private */
    function mouseup() {
        if (!scene) return;
        p.fix = null;
        scene.mark.context(scene, index, function() { this.render(); });
        pv.Mark.dispatch("dragend", scene, index);
        scene = null;
    }

    pv.listen(window, "mousemove", mousemove);
    pv.listen(window, "mouseup", mouseup);
    return mousedown;
};

function linkedBrush(foodsObj) {
  var cls = 'linked-' + foodsObj.color;
  for (foodIdx in foodsObj.foods) 
    $('#' + foodsObj.foods[foodIdx].food).addClass(cls);
  console.log($('#'+foodsObj.foods[0].food));
}

function clearLinkedBrush(foodsObj) {
  var cls = 'linked-' + foodsObj.color;
  for (foodIdx in foodsObj.foods) 
    $('#' + foodsObj.foods[foodIdx].food).removeClass(cls);

}

function getCurrentAngle() {
    return handle[1].theta;
}

// Gets the month that the handle is currently resting on
function getSelectedMonth() {
    var theta = getCurrentAngle();
    for (m in monthAngles)
        if (theta >= monthAngles[m].startAngle &&
            theta <= monthAngles[m].endAngle)
            return monthAngles[m].month;
}

// The actual handle itself
var handle = [
    // Center
    {
        x: xCenter,
        y: yCenter,
        origin: true
    },
    // Handle
    {
        // Default the handle location to initAngle
        x: (Math.cos(initAngle) * (radius * 0.965)) + xCenter,
        y: (Math.sin(initAngle) * (radius * 0.965)) + yCenter,
        theta: initAngle
    }
];
// Handle line
vis.add(pv.Line)
    .data(function() handle)
    .left(function(d) d.x)
    .top(function(d) d.y)
    .interpolate("linear")
    .segmented(false)
    .strokeStyle("#99ccff")
    .lineWidth(2);

// Handle dot
vis.add(pv.Dot)
    .data(function() handle)
    .left(function(d) d.x)
    .top(function(d) d.y)
    .radius(7)
    .cursor(function(d) d.origin == true ? "" : "move")
    .strokeStyle(function(d) d.origin == true ? null : "#99ccff")
    .fillStyle(function(d) d.origin == true ? null : this.strokeStyle().alpha(.4))
    .event("mousedown", pv.Behavior.dragCircle())
    .event("dragstart", null)
    .event("drag", handleUpdate);

function handleUpdate() {
    CURRENT_MONTH = getSelectedMonth();
    // So we don't overload the API/cache
    if (CURRENT_MONTH != OTHER_MONTH) {
        OTHER_MONTH = CURRENT_MONTH;
        
        $("#nutrientsTB").empty();
        
        var foods = selectedFoods(CURRENT_STATE, CURRENT_MONTH);
        console.log(foods);
        
        fs_getFoods(foods, function(food) {
            
            console.log(food);            
            var servingsList = food.food.servings.serving;
            var serving;
            
            for (s in servingsList) {
                if (servingsList[s].metric_serving_amount == "100.000") {
                    serving = servingsList[s];
                    console.log("Found 100g serving");
                    console.log(serving);
                    break;
                }
            }
            
            if (!serving) {
                serving = servingsList[0];
                console.log("No 100g serving found; defaulting to first serving");
                console.log(serving);
            }
            
            var foodHtml =
            '<tr id="' + food.ourFoodName + '">' +
                '<td>' + food.food.food_name + '</td>' +
                '<td>' + serving.protein + '</td>' +
                '<td>' + serving.calcium + '</td>' +
                '<td>' + serving.sodium + '</td>' +
                '<td>' + serving.fiber + '</td>' +
                '<td>' + serving.vitamin_c + '</td>' +
                '<td>' + serving.potassium + '</td>' +
                '<td>' + serving.fat + '</td>' +
            '</tr>';
                
            $("#nutrientsTB").append(foodHtml);
        });
  }
  vis.render();
}

handleUpdate();

vis.render();
pv.listen(window, "mousedown", function() self.focus());

      </script>
      </div>
    </div>
    <div class="row" id="nutrients">
      <table>
        <thead>
          <th>Name</th>
          <th>Protein (g)</th>
          <th>Calcium (mg)</th>
          <th>Sodium (mg)</th>
          <th>Fiber (g)</th>
          <th>Vitamin C (mg)</th>
          <th>Potassium (mg)</th>
          <th>Fat (g)</th>
        </thead>
        <tbody id="nutrientsTB">
        </tbody>
      </table>
    </div>
  </div>
  
</body>
</html>
